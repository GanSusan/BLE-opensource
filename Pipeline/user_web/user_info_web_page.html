<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áî®Êà∑‰ø°ÊÅØÈÖçÁΩÆ - È•±‰∫ÜÂêó</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 30%;
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        .center-panel {
            width: 40%;
            padding: 30px;
            overflow-y: auto;
            border-right: 2px solid #e0e0e0;
        }

        .right-panel {
            width: 30%;
            padding: 30px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .current-config {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .default-users {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .default-users h3 {
            color: #1565c0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .user-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .user-btn {
            padding: 10px;
            background: #bbdefb;
            border: 1px solid #90caf9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
        }

        .user-btn:hover {
            background: #90caf9;
            transform: translateY(-2px);
        }

        .user-details {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #a5d6a7;
        }

        .user-details h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .select-user-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-user-btn:hover {
            background: #388e3c;
        }

        .current-config h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .config-item {
            margin-bottom: 10px;
            color: #333;
            font-size: 0.95em;
        }

        .config-item strong {
            color: #2e7d32;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9em;
        }

        .checkbox-item:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #4facfe;
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9em;
        }

        .radio-item:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
        }

        .radio-item input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #4facfe;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        /* ÁªìÊûúÂ±ïÁ§∫Âå∫ÂüüÊ†∑Âºè */
        .result-container {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .result-content {
            color: #666;
        }

        .result-time {
            font-size: 0.8em;
            color: #999;
            text-align: right;
        }

        .result-duration {
            font-size: 0.9em;
            color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .left-panel, .center-panel, .right-panel {
                width: 50%;
            }
            .right-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
                height: calc(100vh - 20px);
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .left-panel, .center-panel, .right-panel {
                width: 100%;
                padding: 20px;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            
            .checkbox-group, .radio-group {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è È•±‰∫ÜÂêó</h1>
            <p>‰∏™ÊÄßÂåñÁî®Êà∑‰ø°ÊÅØÈÖçÁΩÆ</p>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <div id="currentConfig" class="current-config">
                    <h3>üìã ÂΩìÂâçÈÖçÁΩÆ</h3>
                    <div id="configDisplay">
                        <div class="config-item">ÊöÇÊó†ÈÖçÁΩÆ‰ø°ÊÅØ</div>
                    </div>

                    <div class="default-users">
                        <h3>üë• ÈªòËÆ§Áî®Êà∑</h3>
                        <div class="user-buttons" id="defaultUsers">
                            <!-- ËøôÈáåÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂä†ËΩΩÈªòËÆ§Áî®Êà∑ÊåâÈíÆ -->
                        </div>
                        <div class="user-details" id="userDetails" style="display: none;">
                            <h4>Áî®Êà∑ËØ¶ÊÉÖ</h4>
                            <div id="userDetailsContent"></div>
                            <button class="select-user-btn" id="selectUserBtn">ÈÄâÊã©Ê≠§Áî®Êà∑</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="center-panel">
                <form id="userForm">
                    <div class="form-group">
                        <label for="user_id">üë§ Áî®Êà∑ID</label>
                        <input type="number" id="user_id" name="user_id" class="form-control" required min="1">
                    </div>

                    <div class="form-group">
                        <label for="name">üìù ÂßìÂêç</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>üë´ ÊÄßÂà´</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="gender" value="Male" required>
                                <span>Áî∑ÊÄß</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="gender" value="Female" required>
                                <span>Â•≥ÊÄß</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üéÇ Âπ¥ÈæÑÊÆµ</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="age_range" value="60-70" required>
                                <span>60-70Â≤Å</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="age_range" value="70-80" required>
                                <span>70-80Â≤Å</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="age_range" value="80-90" required>
                                <span>80-90Â≤Å</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üåç Âú∞Âå∫</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="region" value="‰∏úÂåóÂú∞Âå∫" required>
                                <span>‰∏úÂåóÂú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="Ë•øÂåóÂú∞Âå∫" required>
                                <span>Ë•øÂåóÂú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="ÂçéÂåóÂú∞Âå∫" required>
                                <span>ÂçéÂåóÂú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="Âçé‰∏úÂú∞Âå∫" required>
                                <span>Âçé‰∏úÂú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="Âçé‰∏≠Âú∞Âå∫" required>
                                <span>Âçé‰∏≠Âú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="Ë•øÂçóÂú∞Âå∫" required>
                                <span>Ë•øÂçóÂú∞Âå∫</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="region" value="ÂçéÂçóÂú∞Âå∫" required>
                                <span>ÂçéÂçóÂú∞Âå∫</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üè• ÂÅ•Â∫∑Áä∂ÂÜµÔºàÂèØÂ§öÈÄâ, ÂÅ•Â∫∑‰∏éÁñæÁóÖ‰∫íÊñ•Ôºâ</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="ËÇ•ËÉñ">
                                <span>ËÇ•ËÉñ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="È´òË°ÄÂéã">
                                <span>È´òË°ÄÂéã</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="Á≥ñÂ∞øÁóÖ">
                                <span>Á≥ñÂ∞øÁóÖ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="ËÇæÁóÖ">
                                <span>ËÇæÁóÖ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="È´òË°ÄËÑÇ">
                                <span>È´òË°ÄËÑÇ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="È´òË°ÄÁ≥ñ">
                                <span>È´òË°ÄÁ≥ñ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="ËÉÉÁóÖ">
                                <span>ËÉÉÁóÖ</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="ÂÖ≥ËäÇÁÇé">
                                <span>ÂÖ≥ËäÇÁÇé</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="‰æøÁßò">
                                <span>‰æøÁßò</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="health_conditions" value="ÂÅ•Â∫∑" id="healthy">
                                <span>ÂÅ•Â∫∑</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üëÖ Âè£Âë≥ÂÅèÂ•Ω</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="Ê∏ÖÊ∑°" required>
                                <span>Ê∏ÖÊ∑°</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="ÈÖ∏" required>
                                <span>ÈÖ∏Âë≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="È≤ú" required>
                                <span>È≤úÂë≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="Áîú" required>
                                <span>ÁîúÂë≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="Ëæ£" required>
                                <span>Ëæ£Âë≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="Âí∏" required>
                                <span>Âí∏Âë≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="taste_preferences" value="Ëã¶" required>
                                <span>Ëã¶Âë≥</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ü•¢ Âè£ÊÑüÂÅèÂ•Ω</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="ËΩØÁÉÇ" required>
                                <span>ËΩØÁÉÇ</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="ÊòìÂíÄÂöº" required>
                                <span>ÊòìÂíÄÂöº</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="È°∫Êªë" required>
                                <span>È°∫Êªë</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="Ê∏©ÁÉ≠" required>
                                <span>Ê∏©ÁÉ≠</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="Ê∏ÖÂáâ" required>
                                <span>Ê∏ÖÂáâ</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="Â∏∏Ê∏©" required>
                                <span>Â∏∏Ê∏©</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="ÈÖ•ËÑÜ" required>
                                <span>ÈÖ•ËÑÜ</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="QÂºπ" required>
                                <span>QÂºπ</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="texture_preferences" value="Á≠ãÈÅì" required>
                                <span>Á≠ãÈÅì</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">‚ú® ‰øùÂ≠òÈÖçÁΩÆ</button>
                </form>
            </div>

            <div class="right-panel">
                <h3>üìä ËØ≠Èü≥ËØÜÂà´ÁªìÊûú</h3>
                <div id="resultHistory" class="result-container">
                    <div class="result-item">
                        <div class="result-content">ÊöÇÊó†ËØÜÂà´ËÆ∞ÂΩï</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ÂΩìÂâçÁî®Êà∑ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
        let currentUserOrderHistory = [];
        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ÂΩìÂâçÁî®Êà∑ÈÖçÁΩÆ
        let currentUserConfig = {};
        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ËØÜÂà´ÁªìÊûúÂéÜÂè≤
        let recognitionHistory = [];

        // ÂàùÂßãÂåñWebSocketËøûÊé•
        let socket;

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñWebSocketËøûÊé•
        window.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñSocket.IOËøûÊé•
            socket = io();
            
            // ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ
            socket.on('connect', function() {
                console.log('Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
            });
            
            socket.on('disconnect', function() {
                console.log('‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
            });
            
            // ÁõëÂê¨ËØÜÂà´ÁªìÊûú
            socket.on('recognition_result', function(data) {
                console.log('Êî∂Âà∞ËØÜÂà´ÁªìÊûú:', data);
                addRecognitionResult(data);
            });
            
            // ÂéüÊúâÁöÑÂàùÂßãÂåñ‰ª£Á†Å
            loadCurrentConfig();
            loadDefaultUsers();
        });

        // ÂÅ•Â∫∑Áä∂ÂÜµ‰∫íÊñ•ÈÄªËæë
        const healthCheckboxes = document.querySelectorAll('input[name="health_conditions"]');
        const healthyCheckbox = document.getElementById('healthy');
        
        healthCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'ÂÅ•Â∫∑') {
                    if (this.checked) {
                        // ÈÄâÊã©ÂÅ•Â∫∑Êó∂ÔºåÂèñÊ∂àÂÖ∂‰ªñÊâÄÊúâÁñæÁóÖÈÄâÊã©
                        healthCheckboxes.forEach(cb => {
                            if (cb.value !== 'ÂÅ•Â∫∑') {
                                cb.checked = false;
                            }
                        });
                    }
                } else {
                    // ÈÄâÊã©ÁñæÁóÖÊó∂ÔºåÂèñÊ∂àÂÅ•Â∫∑ÈÄâÊã©
                    if (this.checked) {
                        healthyCheckbox.checked = false;
                    }
                }
            });
        });

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
        window.addEventListener('DOMContentLoaded', function() {
            loadCurrentConfig();
            loadDefaultUsers();
        });

        // Âä†ËΩΩÈªòËÆ§Áî®Êà∑
        function loadDefaultUsers() {
            fetch('/get_default_users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200 && data.data && data.data.length > 0) {
                    displayDefaultUsers(data.data);
                }
            })
            .catch(error => {
                console.log('Ëé∑ÂèñÈªòËÆ§Áî®Êà∑Â§±Ë¥•:', error);
            });
        }

        // ÊòæÁ§∫ÈªòËÆ§Áî®Êà∑ÊåâÈíÆ
        function displayDefaultUsers(users) {
            const usersContainer = document.getElementById('defaultUsers');
            usersContainer.innerHTML = '';
            
            users.forEach(user => {
                const btn = document.createElement('button');
                btn.className = 'user-btn';
                btn.textContent = user.name;
                btn.onclick = () => showUserDetails(user);
                usersContainer.appendChild(btn);
            });
        }

        // ÊòæÁ§∫Áî®Êà∑ËØ¶ÊÉÖ
        function showUserDetails(user) {
            const detailsContainer = document.getElementById('userDetailsContent');
            const userDetailsSection = document.getElementById('userDetails');
            
            // Ê†ºÂºèÂåñËÆ¢ÂçïÂéÜÂè≤
            const orderHistory = user.order_history || [];
            const ordersHtml = orderHistory.map(order => 
                `<div><strong>${order.date}:</strong> ${order.dishes.join(', ')}</div>`
            ).join('');
            
            detailsContainer.innerHTML = `
                <div><strong>ID:</strong> ${user.id}</div>
                <div><strong>ÂßìÂêç:</strong> ${user.name}</div>
                <div><strong>ÊÄßÂà´:</strong> ${user.gender}</div>
                <div><strong>Âπ¥ÈæÑÊÆµ:</strong> ${user.age_range}</div>
                <div><strong>Âú∞Âå∫:</strong> ${user.region}</div>
                <div><strong>ÂÅ•Â∫∑Áä∂ÂÜµ:</strong> ${user.health_conditions.join(', ')}</div>
                <div><strong>Âè£Âë≥ÂÅèÂ•Ω:</strong> ${user.taste_preferences.join(', ')}</div>
                <div><strong>Âè£ÊÑüÂÅèÂ•Ω:</strong> ${user.texture_preferences.join(', ')}</div>
                
                <div style="margin-top: 15px;"><strong>ËÆ¢ÂçïÂéÜÂè≤:</strong></div>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 5px;">
                    ${ordersHtml}
                </div>
            `;
            
            // ËÆæÁΩÆÈÄâÊã©ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('selectUserBtn').onclick = () => selectUser(user);
            
            userDetailsSection.style.display = 'block';
        }

        // ÈÄâÊã©Áî®Êà∑
        function selectUser(user) {
            // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
            currentUserOrderHistory = user.order_history || [];
            
            // Â°´ÂÖÖË°®Âçï
            fillForm(user);
            
            // ÈöêËóèËØ¶ÊÉÖ
            document.getElementById('userDetails').style.display = 'none';
            
            // ÊòæÁ§∫ÂΩìÂâçÈÖçÁΩÆ
            displayCurrentConfig(user);
            
            // Ëá™Âä®ÊªöÂä®Âà∞Ë°®ÂçïÈ°∂ÈÉ®
            document.querySelector('.center-panel').scrollTo(0, 0);
        }

        // Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆ
        function loadCurrentConfig() {
            fetch('/get_user_config', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200 && data.data) {
                    // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
                    currentUserOrderHistory = data.data.order_history || [];
                    currentUserConfig = data.data;
                    displayCurrentConfig(data.data);
                    fillForm(data.data);
                }
            })
            .catch(error => {
                console.log('Ëé∑ÂèñÈÖçÁΩÆÂ§±Ë¥•:', error);
            });
        }

        // ÊòæÁ§∫ÂΩìÂâçÈÖçÁΩÆ
        function displayCurrentConfig(config) {
            const configDiv = document.getElementById('configDisplay');
            
            // Ê†ºÂºèÂåñËÆ¢ÂçïÂéÜÂè≤
            const orderHistory = config.order_history || [];
            const ordersHtml = orderHistory.length > 0 
                ? orderHistory.map(order => 
                    `<div><strong>${order.date}:</strong> ${order.dishes.join(', ')}</div>`
                ).join('')
                : '<div>Êó†ÂéÜÂè≤ËÆ∞ÂΩï</div>';
            
            configDiv.innerHTML = `
                <div class="config-item"><strong>Áî®Êà∑ID:</strong> ${config.id || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>ÂßìÂêç:</strong> ${config.name || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>ÊÄßÂà´:</strong> ${config.gender || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>Âπ¥ÈæÑÊÆµ:</strong> ${config.age_range || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>Âú∞Âå∫:</strong> ${config.region || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>ÂÅ•Â∫∑Áä∂ÂÜµ:</strong> ${(config.health_conditions || []).join(', ') || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>Âè£Âë≥ÂÅèÂ•Ω:</strong> ${config.taste_preferences || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item"><strong>Âè£ÊÑüÂÅèÂ•Ω:</strong> ${config.texture_preferences || 'Êú™ËÆæÁΩÆ'}</div>
                <div class="config-item" style="margin-top: 15px;"><strong>ÂéÜÂè≤ËÆ¢Âçï:</strong></div>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 5px; padding: 5px; background: #f5f5f5; border-radius: 5px;">
                    ${ordersHtml}
                </div>
            `;
        }

        // Â°´ÂÖÖË°®Âçï
        function fillForm(config) {
            if (config.id) document.getElementById('user_id').value = config.id;
            if (config.name) document.getElementById('name').value = config.name;
            
            if (config.gender) {
                const genderRadio = document.querySelector(`input[name="gender"][value="${config.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
            }
            
            if (config.age_range) {
                const ageRadio = document.querySelector(`input[name="age_range"][value="${config.age_range}"]`);
                if (ageRadio) ageRadio.checked = true;
            }
            
            if (config.region) {
                const regionRadio = document.querySelector(`input[name="region"][value="${config.region}"]`);
                if (regionRadio) regionRadio.checked = true;
            }
            
            if (config.health_conditions) {
                // ÂÖàÂèñÊ∂àÊâÄÊúâÈÄâÊã©
                document.querySelectorAll('input[name="health_conditions"]').forEach(cb => cb.checked = false);
                
                // ÁÑ∂ÂêéÈÄâÊã©ÂΩìÂâçÈÖçÁΩÆ
                config.health_conditions.forEach(condition => {
                    const checkbox = document.querySelector(`input[name="health_conditions"][value="${condition}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (config.taste_preferences) {
                const tasteRadio = document.querySelector(`input[name="taste_preferences"][value="${config.taste_preferences}"]`);
                if (tasteRadio) tasteRadio.checked = true;
            }
            
            if (config.texture_preferences) {
                const textureRadio = document.querySelector(`input[name="texture_preferences"][value="${config.texture_preferences}"]`);
                if (textureRadio) textureRadio.checked = true;
            }
        }

        // Ê∑ªÂä†ËØÜÂà´ÁªìÊûúÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
        // function addRecognitionResult(resultData) {
        //     recognitionHistory.unshift(resultData);
        //     if (recognitionHistory.length > 5) {
        //         recognitionHistory.pop();
        //     }
        //     updateResultDisplay();
        // }
        // ‰øÆÊîπaddRecognitionResultÂáΩÊï∞‰ª•ÈÄÇÂ∫îÊñ∞ÁöÑÊï∞ÊçÆÊ†ºÂºè
        function addRecognitionResult(resultData) {
            const newResult = {
                ext: {
                    asr_result: resultData.asr_result,
                    recommended_dish: resultData.recommended_dish,
                    processing_time: resultData.processing_time,
                    timestamp: resultData.timestamp
                }
            };
            
            recognitionHistory.unshift(newResult);
            if (recognitionHistory.length > 10) {  // Â¢ûÂä†ÂéÜÂè≤ËÆ∞ÂΩï‰øùÂ≠òÊï∞Èáè
                recognitionHistory.pop();
            }
            updateResultDisplay();
        }
        // Êõ¥Êñ∞ÁªìÊûúÂ±ïÁ§∫
        function updateResultDisplay() {
            const resultContainer = document.getElementById('resultHistory');
            
            if (recognitionHistory.length === 0) {
                resultContainer.innerHTML = `
                    <div class="result-item">
                        <div class="result-content">ÊöÇÊó†ËØÜÂà´ËÆ∞ÂΩï</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            recognitionHistory.forEach(result => {
                html += `
                    <div class="result-item">
                        <div class="result-title">ËØÜÂà´ÊñáÊú¨:</div>
                        <div class="result-content">${result.ext.asr_result}</div>
                        
                        <div class="result-title" style="margin-top: 10px;">Êé®ËçêËèúÂìÅ:</div>
                        <div class="result-content">${result.ext.recommended_dish}</div>
                        
                        <div class="result-duration">ËÄóÊó∂: ${result.ext.processing_time}ms</div>
                        <div class="result-time">${result.ext.timestamp}</div>
                    </div>
                `;
            });
            
            resultContainer.innerHTML = html;
        }

        // Ë°®ÂçïÊèê‰∫§
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const userInfo = {
                id: parseInt(formData.get('user_id')),
                name: formData.get('name'),
                gender: formData.get('gender'),
                age_range: formData.get('age_range'),
                region: formData.get('region'),
                health_conditions: formData.getAll('health_conditions'),
                taste_preferences: formData.get('taste_preferences'),
                texture_preferences: formData.get('texture_preferences'),
                // ‰øùÁïôÁé∞ÊúâÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                order_history: currentUserOrderHistory || []
            };

            // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÈÖçÁΩÆ
            currentUserConfig = userInfo;

            // Êèê‰∫§Êï∞ÊçÆ
            fetch('/set_user_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userInfo)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('‚úÖ ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
                    displayCurrentConfig(userInfo);
                } else {
                    alert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            });
        });

        // Ê®°ÊãüËØ≠Èü≥ËØÜÂà´ÁªìÊûúÔºàÂÆûÈôÖ‰ΩøÁî®Êó∂Â∫îËØ•‰ªéÁúüÂÆûÁöÑËØ≠Èü≥ËØÜÂà´ÂõûË∞É‰∏≠Ë∞ÉÁî®addRecognitionResultÔºâ
        function simulateVoiceRecognition() {
            const mockResponse = {
                code: 200,
                message: "success",
                data: {
                    result: "ÁªôÊàëÁÇπÊ∏ÖËí∏È≤àÈ±º",
                    ext: {
                        user_info: currentUserConfig,
                        asr_result: "ÊàëÊÉ≥ÂêÉÊ∏ÖËí∏È≤àÈ±º",
                        recommended_dish: "Ê∏ÖËí∏È≤àÈ±º",
                        processing_time: 1250,
                        timestamp: new Date().toLocaleString()
                    }
                }
            };
            
            addRecognitionResult(mockResponse.data);
        }

        // Ê®°ÊãüËØ≠Èü≥ËØÜÂà´ÊåâÈíÆÔºàÂÆûÈôÖ‰ΩøÁî®Êó∂Â∫îËØ•ËøûÊé•Âà∞ÁúüÂÆûÁöÑËØ≠Èü≥ËØÜÂà´ÊåâÈíÆÔºâ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.ctrlKey) {
                simulateVoiceRecognition();
            }
        });
    </script>
</body>
</html>